name: Build Veyon on Windows

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: windows-latest

    steps:
      # -----------------------------------------------------------
      # 1. CHECKOUT REPO
      # -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # -----------------------------------------------------------
      # 2. DELETE REPO MANIFEST
      # -----------------------------------------------------------
      - name: Nuke vcpkg.json
        shell: pwsh
        run: |
          if (Test-Path "vcpkg.json") {
            Remove-Item "vcpkg.json" -Force
            Write-Host "DELETED vcpkg.json -> Switching to Manual Mode."
          }

      # -----------------------------------------------------------
      # 3. SETUP VCPKG (With File Repair)
      # -----------------------------------------------------------
      - name: Setup VCPKG and Install Libs
        shell: pwsh
        run: |
          # 1. Prepare Directory
          $workDir = "C:\vcpkg_clean"
          New-Item -ItemType Directory -Force -Path $workDir | Out-Null
          cd $workDir
          
          # 2. Clone VCPKG (Master branch usually works if files are clean)
          Write-Host "Cloning vcpkg..."
          git clone -c core.autocrlf=false https://github.com/microsoft/vcpkg.git .
          
          # 3. Bootstrap
          .\bootstrap-vcpkg.bat
          
          # -------------------------------------------------------
          # THE FIX: REPAIR THE PORT FILES
          # -------------------------------------------------------
          # We force the config files for libvncserver to have LF endings and UTF8 encoding.
          $portDir = "ports\libvncserver"
          Write-Host "Sanitizing port files in $portDir ..."
          
          if (Test-Path $portDir) {
             Get-ChildItem $portDir -File | ForEach-Object {
                $content = Get-Content $_.FullName -Raw
                # Force Unix Line Endings (\n) instead of Windows (\r\n)
                $content = $content.Replace("`r`n", "`n")
                # Save back as UTF8 without BOM (Best for vcpkg)
                [System.IO.File]::WriteAllText($_.FullName, $content)
                Write-Host " - Repaired: $($_.Name)"
             }
          } else {
             Write-Error "Port directory $portDir NOT FOUND. The port might have been renamed."
             # List ports starting with libvnc just in case
             Get-ChildItem ports | Where-Object { $_.Name -like "*vnc*" } | Select-Object Name
             exit 1
          }

          # -------------------------------------------------------
          # 4. INSTALL
          # -------------------------------------------------------
          Write-Host "Installing Libraries..."
          .\vcpkg.exe install libvncserver:x64-windows lzo:x64-windows openssl:x64-windows

          # 5. Save paths for CMake
          "VCPKG_ROOT=$workDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # -----------------------------------------------------------
      # 4. INSTALL QT 5.15.2
      # -----------------------------------------------------------
      - name: Install Qt 5.15.2
        id: install-qt
        uses: jurplel/install-qt-action@v4
        with:
          version: 5.15.2
          host: windows
          target: desktop
          arch: win64_msvc2019_64

      # -----------------------------------------------------------
      # 5. SETUP MSVC + NINJA
      # -----------------------------------------------------------
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@v4

      # -----------------------------------------------------------
      # 6. BUILD QCA
      # -----------------------------------------------------------
      - name: Clone QCA Source
        run: git clone --depth 1 --branch master https://github.com/KDE/qca.git qca_src

      - name: Configure QCA
        shell: pwsh
        run: |
          mkdir qca_build
          cd qca_build
          cmake -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX="${{ runner.temp }}/qca-install" `
            -DCMAKE_PREFIX_PATH="${{ steps.install-qt.outputs.qt_dir }}" `
            -DBUILD_PLUGINS=OFF `
            -DQCA_FEATURE_BOTAN=OFF `
            -DQCA_FEATURE_OPENSSL=OFF `
            -DQCA_FEATURE_PKCS11=OFF `
            -DQCA_FEATURE_GNUPG=OFF `
            -DQCA_FEATURE_NSS=OFF `
            -DQCA_FEATURE_GCRYPT=OFF `
            -DBUILD_TESTS=OFF `
            ../qca_src

      - name: Build and Install QCA
        run: |
          cd qca_build
          ninja
          ninja install

      # -----------------------------------------------------------
      # 7. PATCH VEYON
      # -----------------------------------------------------------
      - name: Patch Veyon CMakeLists for Qt5
        shell: pwsh
        run: |
          $file = "CMakeLists.txt"
          (Get-Content $file) -replace 'find_package\(Qt6', 'find_package(Qt5' | Set-Content $file
          Write-Host "Patched Veyon to use Qt5."

      # -----------------------------------------------------------
      # 8. CONFIGURE VEYON
      # -----------------------------------------------------------
      - name: Configure Veyon Build
        shell: pwsh
        run: |
          mkdir build
          cd build
          
          # Pass Toolchain File + Prefix Path
          cmake -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DCMAKE_PREFIX_PATH="${{ steps.install-qt.outputs.qt_dir }};${{ runner.temp }}/qca-install" `
            ..

      # -----------------------------------------------------------
      # 9. BUILD VEYON
      # -----------------------------------------------------------
      - name: Build Veyon
        run: |
          cd build
          ninja

      # -----------------------------------------------------------
      # 10. ARTIFACTS
      # -----------------------------------------------------------
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: veyon-windows-build
          path: build/**
