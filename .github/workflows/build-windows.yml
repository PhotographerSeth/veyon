name: Debug Veyon Build

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  debug_environment:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. REMOVE ANY EXISTING MANIFEST TO CLEAR CONFUSION
      - name: Nuke vcpkg.json
        shell: pwsh
        run: |
          if (Test-Path "vcpkg.json") { 
            Remove-Item "vcpkg.json" -Force 
            Write-Host "Deleted repository vcpkg.json to ensure clean slate."
          }

      # 2. INSTALL DEPENDENCIES (Classic Mode)
      - name: Install LibVNCServer
        shell: pwsh
        run: |
          Write-Host "Installing dependencies..."
          vcpkg install libvncserver:x64-windows
          vcpkg install lzo:x64-windows

      # 3. THE "RECONNAISSANCE" STEP
      - name: Run Diagnostics
        shell: pwsh
        run: |
          Write-Host "=========================================="
          Write-Host " ENVIRONMENT VARIABLES"
          Write-Host "=========================================="
          dir env:VCPKG* | Format-Table -AutoSize

          Write-Host "`n=========================================="
          Write-Host " VCPKG STATUS"
          Write-Host "=========================================="
          vcpkg list

          Write-Host "`n=========================================="
          Write-Host " FILE SYSTEM SEARCH (Where are the .lib files?)"
          Write-Host "=========================================="
          # Search the ENTIRE vcpkg root for any .lib file to see where they are landing
          $root = $env:VCPKG_INSTALLATION_ROOT
          Write-Host "Searching inside: $root"
          
          # Find all .lib files, but limit output to avoid log truncation
          $files = Get-ChildItem -Path $root -Filter "*.lib" -Recurse -ErrorAction SilentlyContinue
          
          if ($files) {
            Write-Host "Found $($files.Count) .lib files. Here are the first 20 related to VNC or LZO:"
            $files | Where-Object { $_.Name -match "vnc|lzo" } | Select-Object -First 20 FullName
          } else {
            Write-Host "CRITICAL: No .lib files found anywhere in VCPKG root!"
          }

          Write-Host "`n=========================================="
          Write-Host " SPECIFIC FOLDER CHECK"
          Write-Host "=========================================="
          $targetPath = "$root/installed/x64-windows/lib"
          if (Test-Path $targetPath) {
             Write-Host "Contents of $targetPath :"
             Get-ChildItem $targetPath | Select-Object Name
          } else {
             Write-Host "Folder $targetPath does NOT exist."
          }
